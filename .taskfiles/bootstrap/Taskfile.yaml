---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:

  talos:
    desc: Bootstrap Talos [CLUSTER=main]
    deps:
      - task: genconfig
    cmds:
      - for: { var: TALOS_NODES }
        cmd: >
          talhelper gencommand --config-file {{.TALOS_DIR}}/talconfig.yaml --out-dir {{.TALOS_DIR}}/clusterconfig/ apply --node {{.ITEM}} --extra-flags --insecure | sh
      - until talosctl --talosconfig {{.CLUSTER_CONFIG}} --nodes {{.TALOS_CONTROLLER}} bootstrap; do sleep 5; done
      - talosctl --talosconfig {{.CLUSTER_CONFIG}} kubeconfig --nodes {{.TALOS_CONTROLLER}} --force --force-context-name {{.CLUSTER}} &>/dev/null
    vars:
      CLUSTER_CONFIG: "{{.TALOS_DIR}}/clusterconfig/talosconfig"
      TALOS_CONTROLLER:
        sh: talosctl config info --talosconfig {{.CLUSTER_CONFIG}} --output json | jq --raw-output '.endpoints[]' | shuf -n 1
      TALOS_NODES:
        sh: ls {{.TALOS_DIR}}/clusterconfig/*.yaml | xargs basename | sed 's/^{{.CLUSTER}}-//; s/\.yaml$//'
    requires:
      vars: [CLUSTER]
    preconditions:
      - test -f {{.CLUSTER_CONFIG}}
      - talosctl config info --talosconfig {{.CLUSTER_CONFIG}}
      - test -f talosconfig
      - which jq ls sops talosctl shuf talhelper

  kubernetes:
    desc: Bootstrap Kubernetes Cluster [CLUSTER=main]
    cmds:
      - task: namespaces
      - task: resources
      - task: crds
      - task: apps
    requires:
      vars: [CLUSTER]
    preconditions:
      - which kubectl kustomize yq op helmfile
      - kubectl get nodes

  namespaces:
    internal: true
    cmds:
      - for: { var: NS }
        cmd: >
          kubectl apply --server-side --field-manager bootstrap --force-conflicts -f {{.ITEM}}
    vars:
      NS:
        sh: find "{{.CLUSTER_DIR}}/apps" -mindepth 2 -maxdepth 2 -type f -name namespace.yaml

  resources:
    internal: true
    cmds:
      - op inject -i {{.BOOTSTRAP_DIR}}/resources.yaml.j2 | kubectl apply --server-side --field-manager bootstrap --force-conflicts -f -

  crds:
    internal: true
    cmds:
      - helmfile -f "{{.BOOTSTRAP_DIR}}/helmfile.d/00-crds.yaml" template -q | kubectl apply --server-side --field-manager bootstrap --force-conflicts -f -
  
  apps:
    internal: true
    cmds:
      - helmfile -f "{{.BOOTSTRAP_DIR}}/helmfile.d/01-apps.yaml" sync --hide-notes

  genconfig:
    internal: true
    cmds:
      - talhelper genconfig --config-file {{.TALOS_DIR}}/talconfig.yaml --secret-file {{.TALOS_DIR}}/talsecret.sops.yaml --out-dir {{.TALOS_DIR}}/clusterconfig
    requires:
      vars: [CLUSTER]