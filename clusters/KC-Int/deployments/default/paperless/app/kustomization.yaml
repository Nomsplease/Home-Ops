apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - externalSecret.yaml
  - deployment.yaml
  - ingress.sops.yaml
  - service.yaml
  ## Include Voslync Backup
  - ../../../../templates/volsync
  ## Include CNPG Database
  - ../../../../templates/cnpg-db
patches:
  - patch: |
      apiVersion: postgresql.cnpg.io/v1
      kind: Cluster
      metadata:
        name: not-used
      spec:
        backup:
          # Note: serverName version needs to be inclemented
          # when recovering from an existing cnpg cluster
          serverName: &currentCluster "${APP}-cnpg-db-v2"
        bootstrap:
          recovery:
            source: &previousCluster "${APP}-cnpg-db-v1"
            database: app
            owner: app
            secret:
              name: "${APP}-db-secrets"
        # Note: externalClusters is needed when recovering from an existing cnpg cluster
        externalClusters:
          - name: *previousCluster
            barmanObjectStore:
              <<: *barmanObjectStore
              serverName: *previousCluster
    target:
      name: ${APP}-cnpg-db