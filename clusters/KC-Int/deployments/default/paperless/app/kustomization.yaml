apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - externalSecret.yaml
  - deployment.yaml
  - ingress.sops.yaml
  - service.yaml
  ## Include Voslync Backup
  - ../../../../templates/volsync
  ## Include CNPG Database
  - ../../../../templates/cnpg-db
patches:
  - patch: |
      - op: add
        path: /spec/backup
        value:
          serverName: &currentCluster "${APP}-cnpg-db-v2"
      - op: add
        path: /spec/bootstrap
        value:
          recovery:
            source: &previousCluster "${APP}-cnpg-db-v1"
            database: app
            owner: app
            secret:
              name: "${APP}-db-secrets"
      - op: add
        path: /spec/externalClusters
        value:
          - name: *previousCluster
            barmanObjectStore:
              <<: *barmanObjectStore
              serverName: *previousCluster
    target:
      name: ${APP}-cnpg-db