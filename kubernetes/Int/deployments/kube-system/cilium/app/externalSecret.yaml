---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cilium-helm-values
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: cilium-helm-values
    template:
      engineVersion: v2
      data:
        values.yaml: |
            cgroup:
              automount:
                enabled: false
              hostRoot: /sys/fs/cgroup
            ipam:
              mode: kubernetes
            ipv4NativeRoutingCIDR: 10.244.0.0/16
            k8sServiceHost: 127.0.0.1
            k8sServicePort: 7445
            kubeProxyReplacement: true
            kubeProxyReplacementHealthzBindAddr: 0.0.0.0:10256
            l2announcements:
              enabled: true
            localRedirectPolicy: true
            envoy:
              enabled: true
            ingressController:
              enabled: true
              default: true
              service:
                loadBalancerIP: {{ .loadBalancerIP }}
            gatewayAPI:
              enabled: true
            operator:
              rollOutPods: true
            rollOutCiliumPods: true
            securityContext:
              capabilities:
                ciliumAgent:
                  - CHOWN
                  - KILL
                  - NET_ADMIN
                  - NET_RAW
                  - IPC_LOCK
                  - SYS_ADMIN
                  - SYS_RESOURCE
                  - DAC_OVERRIDE
                  - FOWNER
                  - SETGID
                  - SETUID
                cleanCiliumState:
                  - NET_ADMIN
                  - SYS_ADMIN
                  - SYS_RESOURCE
  dataFrom:
    - extract:
        key: traefik