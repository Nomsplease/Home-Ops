---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: appflowy-values
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: appflowy-values
    template:
      engineVersion: v2
      data:
        values.yaml: |
            global:
              scheme: http
              externalHost: {{ .baseURL }}
              ingress:
                nginx:
                  enabled: true
                  className: ingress-nginx

              gotrue:
                adminEmail: {{ .adminEmail }}

              database:
                host: appflowy-db-rw
                name: {{ .appDB }}
                port: 5432
                username: {{ .appUser }}
                adminUsername: {{ .postgresUser }}

              s3:
                createBucket: true
                useMinio: true
                bucket: {{ .bucketName }}
                accessKey: {{ .accessKey }}
                region: us-east-1

              smtp:
                host: smtp.gmail.com
                port: 587
                user: {{ .smtpUsername }}
                email: {{ .smtpUsername }}
                tlsKind: opportunistic

              ai:
                enabled: true

              secret:
                name: appflowy
                create: true
                postgres:
                  adminPassword:
                    key: postgresAdminPassword
                    value: {{ .postgresPassword }}
                  gotrue:
                    postgresPassword:
                      key: gotruePostgresPassword
                      value: {{ .appPassword }}
                    databaseUrl:
                      key: gotrueDatabaseUrl
                  appflowy:
                    postgresPassword:
                      key: postgresPassword
                      value: {{ .appPassword }}
                    databaseUrl:
                      key: appflowyDatabaseUrl
                  ai:
                    databaseUrl:
                      key: aiDatabaseUrl
                gotrue:
                  adminPassword:
                    key: gotrueAdminPassword
                    value: {{ .adminPassword }}
                jwt:
                  secret:
                    key: jwtSecret
                    value: {{ .jwtSecret }}
                smtp:
                  password:
                    key: smtpPassword
                    value: {{ .smtpPassword }}
                s3:
                  secret:
                    key: s3Secret
                    value: {{ .minioPassword }}
                ai:
                  openAIAPIKey:
                    key: openAIAPIKey
                    value: {{ .openAIKey }}

            postgresql:
              enabled: false

            appflowy-gotrue:
              mailer:
                adminEmail: {{ .smtpUsername }}

            minio:
              enabled: false

  dataFrom:
    - extract:
        key: appflowy
    - extract:
        key: cloudnative-pg
    - extract:
        key: SMTP