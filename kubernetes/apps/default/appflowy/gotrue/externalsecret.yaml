---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &app appflowy-gotrue
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: *app
    template:
      engineVersion: v2
      data:
        PORT: "9999"
        GOTRUE_LOG_LEVEL: "debug"
        API_EXTERNAL_URL: "{{ .baseURL }}/gotrue"
        GOTRUE_DB_DRIVER: "postgres"
        GOTRUE_DATABASE_URL: "postgres://{{ .appUser }}:{{ .appPassword }}@appflowy-db-rw:5432/{{ .appDB }}?search_path=auth"
        GOTRUE_SITE_URL: "appflowy-flutter://"
        GOTRUE_URI_ALLOW_LIST: "**"
        GOTRUE_DISABLE_SIGNUP: "false"
        GOTRUE_ADMIN_EMAIL: "{{ .adminEmail }}"
        GOTRUE_ADMIN_PASSWORD: "{{ .adminPassword }}"
        GOTRUE_JWT_SECRET: "{{ .jwtSecret }}"
        GOTRUE_JWT_EXP: "7200"
        GOTRUE_JWT_ADMIN_GROUP_NAME: "supabase_admin"
        GOTRUE_EXTERNAL_GOOGLE_ENABLED: "false"
        GOTRUE_EXTERNAL_GOOGLE_CLIENT_ID: ""
        GOTRUE_EXTERNAL_GOOGLE_SECRET: ""
        GOTRUE_EXTERNAL_GOOGLE_REDIRECT_URI: "${API_EXTERNAL_URL}/callback"
        GOTRUE_EXTERNAL_GITHUB_ENABLED: "false"
        GOTRUE_EXTERNAL_GITHUB_CLIENT_ID: ""
        GOTRUE_EXTERNAL_GITHUB_SECRET: ""
        GOTRUE_EXTERNAL_GITHUB_REDIRECT_URI: "${API_EXTERNAL_URL}/callback"
        GOTRUE_EXTERNAL_DISCORD_ENABLED: "false"
        GOTRUE_EXTERNAL_DISCORD_CLIENT_ID: ""
        GOTRUE_EXTERNAL_DISCORD_SECRET: ""
        GOTRUE_EXTERNAL_DISCORD_REDIRECT_URI: "${API_EXTERNAL_URL}/callback"
        GOTRUE_EXTERNAL_APPLE_ENABLED: "false"
        GOTRUE_EXTERNAL_APPLE_CLIENT_ID: ""
        GOTRUE_EXTERNAL_APPLE_SECRET: ""
        GOTRUE_EXTERNAL_APPLE_REDIRECT_URI: "${API_EXTERNAL_URL}/callback"
        GOTRUE_SAML_ENABLED: "false"
        GOTRUE_SAML_PRIVATE_KEY: "{{ .samlPrivateKey }}"
        GOTRUE_SMTP_HOST: "{{ .smtpHost }}"
        GOTRUE_SMTP_PORT: "{{ .smtpPort }}"
        GOTRUE_SMTP_USER: "{{ .smtpUsername }}"
        GOTRUE_SMTP_PASS: "{{ .smtpPassword }}"
        GOTRUE_SMTP_ADMIN_EMAIL: "{{ .smtpUsername }}"
        GOTRUE_MAILER_AUTOCONFIRM: "false"
        GOTRUE_MAILER_URLPATHS_CONFIRMATION: "/gotrue/verify"
        GOTRUE_MAILER_URLPATHS_INVITE: "/gotrue/verify"
        GOTRUE_MAILER_URLPATHS_RECOVERY: "/gotrue/verify"
        GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE: "/gotrue/verify"
  dataFrom:
    - extract:
        key: appflowy
    - extract:
        key: cloudnative-pg
    - extract:
        key: SMTP