---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &app appflowy
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: *app
    template:
      engineVersion: v2
      data:
        # =============================================================================
        # AppFlowy Cloud - Production Deployment Configuration
        # =============================================================================
        FQDN: "localhost"
        SCHEME: "http"
        APPFLOWY_BASE_URL: "{{ .baseURL }}"
        
        # =============================================================================
        # üóÑÔ∏è DATABASE & CACHE: Core data infrastructure
        # =============================================================================
        POSTGRES_HOST: "appflowy-db-rw"
        POSTGRES_USER: "{{ .appUser }}"
        POSTGRES_PASSWORD: "{{ .appPassword }}"
        POSTGRES_PORT: "5432"
        POSTGRES_DB: "{{ .appDB }}"

        REDIS_HOST: "appflowy-redis"
        REDIS_PORT: "6379"
        
        # =============================================================================
        # üèóÔ∏è INFRASTRUCTURE SERVICES: Object storage and networking
        # =============================================================================
        MINIO_HOST: "appflowy-minio"
        MINIO_PORT: "9000"
        MINIO_BROWSER_REDIRECT_URL: "https://{{ .baseURL}}/minio"
        MINIO_ROOT_USER: "{{ .minioUser }}"
        MINIO_ROOT_PASSWORD: "{{ .minioPassword }}"
        AWS_ACCESS_KEY: "${MINIO_ROOT_USER}"
        AWS_SECRET: "${MINIO_ROOT_PASSWORD}"
        
        # =============================================================================
        # ‚òÅÔ∏è APPFLOWY SERVICES: Application service configuration
        # =============================================================================
        APPFLOWY_GOTRUE_BASE_URL: "http://appflowy-gotrue:9999"
        APPFLOWY_DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"
        APPFLOWY_ACCESS_CONTROL: "true"
        APPFLOWY_WEBSOCKET_MAILBOX_SIZE: "6000"
        APPFLOWY_DATABASE_MAX_CONNECTIONS: "40"
        APPFLOWY_REDIS_URI: "redis://${REDIS_HOST}:${REDIS_PORT}"
        GOTRUE_DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}?search_path=auth"
        
        # =============================================================================
        # üîê GOTRUE: Authentication service configuration
        # =============================================================================
        GOTRUE_ADMIN_EMAIL: "{{ .adminEmail }}"
        GOTRUE_ADMIN_PASSWORD: "{{ .adminPassword }}"
        GOTRUE_JWT_SECRET: "{{ .jwtSecret }}"
        GOTRUE_JWT_EXP: "7200"
        API_EXTERNAL_URL: "${APPFLOWY_BASE_URL}/gotrue"
        GOTRUE_MAILER_AUTOCONFIRM: "false"
        GOTRUE_DISABLE_SIGNUP: "false"
        GOTRUE_SITE_URL: "appflowy-flutter://"
        GOTRUE_URI_ALLOW_LIST: "**"
        GOTRUE_RATE_LIMIT_EMAIL_SENT: "100"
        GOTRUE_MAILER_TEMPLATES_MAGIC_LINK: ""
        GOTRUE_JWT_ADMIN_GROUP_NAME: "supabase_admin"
        GOTRUE_DB_DRIVER: "postgres"
        GOTRUE_MAILER_URLPATHS_CONFIRMATION: "/gotrue/verify"
        GOTRUE_MAILER_URLPATHS_INVITE: "/gotrue/verify"
        GOTRUE_MAILER_URLPATHS_RECOVERY: "/gotrue/verify"
        GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE: "/gotrue/verify"
        GOTRUE_SMTP_MAX_FREQUENCY: "1ns"
        
        # =============================================================================
        # üéõÔ∏è ADMIN FRONTEND: Management interface configuration
        # =============================================================================
        ADMIN_FRONTEND_REDIS_URL: "redis://${REDIS_HOST}:${REDIS_PORT}"
        ADMIN_FRONTEND_GOTRUE_URL: "http://appflowy-gotrue:9999"
        ADMIN_FRONTEND_APPFLOWY_CLOUD_URL: "http://appflowy-cloud:8000"
        ADMIN_FRONTEND_PATH_PREFIX: "/console"
        
        # =============================================================================
        # üìß EMAIL CONFIGURATION: SMTP settings (optional but recommended for production)
        # =============================================================================
        GOTRUE_SMTP_HOST: "{{ .smtpHost }}"
        GOTRUE_SMTP_PORT: "{{ .smtpPort }}"
        GOTRUE_SMTP_USER: "{{ .smtpUsername }}"
        GOTRUE_SMTP_PASS: "{{ .smtpPassword }}"
        GOTRUE_SMTP_ADMIN_EMAIL: "{{ .smtpUsername }}"
        APPFLOWY_MAILER_SMTP_HOST: "{{ .smtpHost }}"
        APPFLOWY_MAILER_SMTP_PORT: "{{ .smtpPort }}"
        APPFLOWY_MAILER_SMTP_USERNAME: "{{ .smtpUsername }}"
        APPFLOWY_MAILER_SMTP_EMAIL: "{{ .smtpUsername }}"
        APPFLOWY_MAILER_SMTP_PASSWORD: "{{ .smtpPassword }}"
        APPFLOWY_MAILER_SMTP_TLS_KIND: "wrapper"
        
        # =============================================================================
        # üîë OAUTH PROVIDERS: Third-party authentication (optional)
        # =============================================================================
        # Refer to this for details: https://github.com/AppFlowy-IO/AppFlowy-Cloud/blob/main/doc/AUTHENTICATION.md
        # Google OAuth2
        GOTRUE_EXTERNAL_GOOGLE_ENABLED: "false"
        GOTRUE_EXTERNAL_GOOGLE_CLIENT_ID: ""
        GOTRUE_EXTERNAL_GOOGLE_SECRET: ""
        GOTRUE_EXTERNAL_GOOGLE_REDIRECT_URI: "${API_EXTERNAL_URL}/callback"
        # GitHub OAuth2
        GOTRUE_EXTERNAL_GITHUB_ENABLED: "false"
        GOTRUE_EXTERNAL_GITHUB_CLIENT_ID: ""
        GOTRUE_EXTERNAL_GITHUB_SECRET: ""
        GOTRUE_EXTERNAL_GITHUB_REDIRECT_URI: "${API_EXTERNAL_URL}/callback"
        # Discord OAuth2
        GOTRUE_EXTERNAL_DISCORD_ENABLED: "false"
        GOTRUE_EXTERNAL_DISCORD_CLIENT_ID: ""
        GOTRUE_EXTERNAL_DISCORD_SECRET: ""
        GOTRUE_EXTERNAL_DISCORD_REDIRECT_URI: "${API_EXTERNAL_URL}/callback"
        # Apple OAuth2
        GOTRUE_EXTERNAL_APPLE_ENABLED: "false"
        GOTRUE_EXTERNAL_APPLE_CLIENT_ID: ""
        GOTRUE_EXTERNAL_APPLE_SECRET: ""
        GOTRUE_EXTERNAL_APPLE_REDIRECT_URI: "${API_EXTERNAL_URL}/callback"
        # SAML 2.0. Refer to https://github.com/AppFlowy-IO/AppFlowy-Cloud/blob/main/doc/OKTA_SAML.md for example using Okta.
        GOTRUE_SAML_ENABLED: "false"
        GOTRUE_SAML_PRIVATE_KEY: "{{ .samlPrivateKey }}"
        
        # =============================================================================
        # üíæ FILE STORAGE: S3/MinIO configuration (required for file uploads)
        # =============================================================================
        APPFLOWY_S3_USE_MINIO: "true"
        APPFLOWY_S3_CREATE_BUCKET: "true"
        APPFLOWY_S3_MINIO_URL: "http://${MINIO_HOST}:${MINIO_PORT}"
        APPFLOWY_S3_ACCESS_KEY: "${AWS_ACCESS_KEY}"
        APPFLOWY_S3_SECRET_KEY: "${AWS_SECRET}"
        APPFLOWY_S3_BUCKET: "{{ .bucketName }}"
        
        # =============================================================================
        # ü§ñ AI FEATURES: Optional AI capabilities (configure only if needed)
        # =============================================================================
        AI_OPENAI_API_KEY: "{{ .openAIKey }}"
        AI_OPENAI_API_SUMMARY_MODEL: "gpt-4o-mini"
        AI_SERVER_PORT: "5001"
        AI_SERVER_HOST: "appflowy-ai"
        AI_DATABASE_URL: "postgresql+psycopg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"
        AI_REDIS_URL: "redis://${REDIS_HOST}:${REDIS_PORT}"
        AI_APPFLOWY_BUCKET_NAME: "${APPFLOWY_S3_BUCKET}"
        AI_APPFLOWY_HOST: "${APPFLOWY_BASE_URL}"
        AI_MINIO_URL: "http://${MINIO_HOST}:${MINIO_PORT}"
        APPFLOWY_EMBEDDING_CHUNK_SIZE: "2000"
        APPFLOWY_EMBEDDING_CHUNK_OVERLAP: "200"
        
        # =============================================================================
        # ‚öôÔ∏è WORKER SERVICES: Background processing (good defaults for production)
        # =============================================================================
        APPFLOWY_INDEXER_ENABLED: "true"
        APPFLOWY_INDEXER_DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"
        APPFLOWY_INDEXER_REDIS_URL: "redis://${REDIS_HOST}:${REDIS_PORT}"
        APPFLOWY_INDEXER_EMBEDDING_BUFFER_SIZE: "5000"
        APPFLOWY_COLLABORATE_MULTI_THREAD: "true"
        APPFLOWY_COLLABORATE_REMOVE_BATCH_SIZE: "100"
        APPFLOWY_WORKER_REDIS_URL: "redis://${REDIS_HOST}:${REDIS_PORT}"
        APPFLOWY_WORKER_DATABASE_URL: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"
        APPFLOWY_WORKER_DATABASE_NAME: "${POSTGRES_DB}"
        
        # =============================================================================
        # üåê WEB FRONTEND: AppFlowy Web interface
        # =============================================================================
        APPFLOWY_WEB_URL: "${APPFLOWY_BASE_URL}"
      
        
        # =============================================================================
        # üõ†Ô∏è INFRASTRUCTURE: Networking, logging, and admin tools
        # =============================================================================
        RUST_LOG: "info"
        AI_TEST_ENABLED: "false"
  dataFrom:
    - extract:
        key: appflowy
    - extract:
        key: cloudnative-pg
    - extract:
        key: SMTP